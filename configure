#!/bin/bash

source config

msg() { echo ":: $@"; }

msg2() { echo "-> $@"; }

if [ "${ip}" = 'cambiar' ]; then
    msg 'Tenés que configurar al menos la IP del nodo (en config)'
    exit 1
fi

msg "Datos del nodo"
msg2 "El responsable del nodo es ${id}"
msg2 "El nombre de la VPN es ${vpn} y su rango es ${rango_vpn}"
msg2 "El nombre del nodo es ${node}"
msg2 "La dirección del nodo es ${address} (siempre es mejor un dominio que una IP)"
msg2 "La red del nodo será ${ip}${subnet}"
msg2 "Si no es correcto presione ^C para cancelar"
read pause

msg "Creando configuración"
msg2 "Creando directorio"

hosts=${vpn}/hosts
mkdir -p ${hosts}

msg2 "Nodo"
touch ${hosts}/${node}

echo "Address = ${address}" >> ${hosts}/${node}
echo "Subnet = ${ip}${subnet}" >> ${hosts}/${node}

sed -e "s/{{ip}}/${ip}/g" \
    -e "s/{{id}}/${id}/g" \
    -e "s/{{rango_vpn}}/${rango_vpn}/g" \
    skel/tinc-up > ${vpn}/tinc-up

sed "s/{{node}}/${node}/g" skel/tinc.conf > ${vpn}/tinc.conf

cp skel/tinc-down ${vpn}/

chmod +x ${vpn}/tinc-{up,down}

msg "Agregando los hosts remotos"
for host in ${conectar_a}; do
    msg2 "${host}"
    echo "ConnectTo = ${host}" >> ${vpn}/tinc.conf
    cp nodos/${host} ${hosts}/
done

tincd -c ${PWD}/${vpn} -n ${vpn} --generate-keys=4096 && \
    msg "La red está configurada"

msg "Firmar el archivo criptográficamente? (s/n)"
read yesno

if [ "${yesno}" = "s" ]; then
    gpg --output ${hosts}/${node}.sig --detach-sig ${hosts}/${node}
fi 

host_files=$(shopt -s nullglob; echo ${hosts}/${node}*)

tar --remove-files -czf ${vpn}.tar.gz ${vpn}/

msg2 "La configuración se encuentra en ${vpn}.tar.gz"
msg2 "Descomprimir en /etc/tinc"

msg "Enviá tu archivo de host a los responsables de los nodos:"
msg2 "${conectar_a[@]}"

msg2 "Archivos a enviar: ${host_files}"

exit $?
