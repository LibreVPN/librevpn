#!/bin/bash

node=${1:-${HOSTNAME}}
address=${2:-$(wget -qO - ifconfig.me/ip)}

let randomip=$RANDOM%255+10

echo ":: El nombre del nodo es Nodo${node}"
echo ":: La dirección del nodo es ${address}"

sed -i "s/{{node}}/Nodo${node}/g" tinc.conf

echo "Address = ${address}" >> hosts/Nodo${node}
echo "Subnet = 192.168.9.${randomip}/32" >> hosts/Nodo${node}

sed -i "s/{{subnet}}/192.168.9.${randomip}/g" tinc-up

echo ":: La subnet será 192.168.9.${randomip}/32"

echo ":: Agregando los hosts remotos"
for host in hosts/*; do
    echo "-> ${node}"
    echo "ConnectTo = ${host}" >> tinc.conf
done

tincd -n lab --generate-keys=4096 && \
    echo 'La red está configurada, ahora corré `tincd -n lab`'

exit $?
