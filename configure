#!/bin/bash

source config

if [ $ip == "cambiar" ]; then
    echo ":: Tenés que configurar al menos la IP del nodo (en config)"
    exit 1
fi

echo ":: Datos del nodo"
echo "-> El nombre de la VPN es ${vpn} y su rango es ${rango_vpn}"
echo "-> El nombre del nodo es ${node}"
echo "-> La dirección del nodo es ${address} (siempre es mejor un dominio que una IP)"
echo "-> La red del nodo será ${ip}${subnet}"
echo "Si no es correcto presione ^C para cancelar"
read pause

echo ":: Creando la rama ${node}"
git checkout -b ${node}

touch nodos/${node}

echo "Address = ${address}" >> nodos/${node}
echo "Subnet = ${ip}${subnet}" >> nodos/${node}

sed -i "s/{{subnet}}/${ip}/g" skel/tinc-up
sed -i "s/{{node}}/${node}/g" skel/tinc.conf

echo ":: Agregando los hosts remotos"
for host in conectar; do
    echo "-> ${host}"
    echo "ConnectTo = ${host}" >> skel/tinc.conf
    cp nodos/${host} skel/hosts/
done

tincd -n ${vpn} --generate-keys=4096 && \
    echo "La red está configurada, ahora corré \`tincd -n ${vpn}\`
y pasale tu archivo hosts/${node} a otro nodo."

git commit -a -m "Configurado ${node}"

exit $?
