#!/bin/bash

if [ $(dirname "${PWD}") != "/etc/tinc" ]; then
    echo ":: Este directorio debe estar bajo /etc/tinc"
    exit 1
fi

source config

echo ":: Datos del nodo"
echo "-> El nombre de la VPN es ${vpn}"
echo "-> El nombre del nodo es ${node}"
echo "-> La dirección del nodo es ${address}"
echo "-> La red será ${ip}/${subnet}"
echo "Si no es correcto presione ^C para cancelar"
read pause

echo ":: Creando la rama ${node}"
git branch ${node}
git checkout ${node}

touch hosts/${node}
git add host/${node}

echo "Address = ${address}" >> hosts/${node}
echo "Subnet = ${ip}/${subnet}" >> hosts/${node}

sed -i "s/{{subnet}}/${ip}\/${subnet}/g" tinc-up
sed -i "s/{{node}}/${node}/g" tinc.conf

echo ":: Agregando los hosts remotos"
pushd hosts
for host in *; do
    echo "-> ${host}"
    echo "ConnectTo = ${host}" >> tinc.conf
done
popd

tincd -n ${vpn} --generate-keys=4096 && \
    echo "La red está configurada, ahora corré \`tincd -n ${vpn}\`
y pasale tu archivo hosts/${node} a otro nodo."

git commit -a -m "Configurado ${node}"

exit $?
